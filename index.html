<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Postcard Generator</title>
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <!-- Fallback font: Merriweather (if primary font not found) -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet" />
  <!-- html2canvas for download -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    body {
      /* We'll override the font family dynamically based on scraped primaryFont */
      font-family: "Merriweather", serif;
    }
    .postcard {
      position: relative;
      width: 100%;
      max-width: 900px;
      /* Use a slightly taller ratio to allow for padding */
      aspect-ratio: 9 / 6;
      display: flex;
      overflow: hidden;
      border-radius: 0.5rem;
      margin: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .download-button {
      position: relative;
      z-index: 10;
    }
    .left-panel {
      padding: 1rem;
      width: 40%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      /* Add some inner spacing so text doesn't touch the edge */
      gap: 0.75rem;
      overflow: auto;
    }
    .right-panel {
      width: 60%;
      position: relative;
    }
    #logoWrapper {
      background-color: rgba(255, 255, 255, 0.6);
      padding: 4px;
      border-radius: 4px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
      margin-bottom: 1rem;
      max-width: 80%;
    }
    #logo {
      width: auto;
      height: 50px;
      object-fit: contain;
    }
    /* Ensure product image fills its panel */
    #productImage {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: 50% 50%;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto p-4">
    <header class="mb-8 text-center">
      <h1 class="text-3xl font-bold text-gray-800">Postcard Generator</h1>
      <p class="text-gray-600">Generate a postcard from your Shopify store URL</p>
    </header>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Left: Settings -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">Enter Store URL</h2>
        <form id="postcardForm" class="space-y-4">
          <div>
            <input type="url" id="websiteUrl" name="websiteUrl" placeholder="https://example.myshopify.com" class="w-full border border-gray-300 p-2 rounded" required />
          </div>
          <div class="flex gap-2">
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Generate Postcard</button>
          </div>
        </form>
        <div class="mt-4">
          <button id="downloadButton" class="download-button bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">Download Postcard</button>
        </div>
      </div>

      <!-- Right: Postcard Preview -->
      <div>
        <h2 class="text-xl font-semibold mb-4">Preview</h2>
        <div id="postcard" class="postcard">
          <div id="postcard-left" class="left-panel" style="background-color: #1F2937; color: #fff;">
            <!-- Logo (if available) -->
            <div id="logoWrapper" style="display: none;">
              <img id="logo" alt="Brand Logo" />
            </div>
            <!-- Product info -->
            <div id="productDetails">
              <h3 id="productName" class="text-lg font-bold"></h3>
              <p id="productPrice" class="text-md"></p>
            </div>
          </div>
          <div id="postcard-right" class="right-panel">
            <img id="productImage" src="" alt="Product Image" style="display: none;" />
          </div>
        </div>
        <!-- Fallback layout -->
        <div id="fallback" class="postcard flex items-center justify-center" style="display: none; background-color: #1F2937; color: #fff;">
          <div class="text-center p-4">
            <p id="fallbackText" class="text-2xl font-bold"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // When the document loads, set up event listeners.
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("postcardForm");
      const downloadBtn = document.getElementById("downloadButton");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const url = document.getElementById("websiteUrl").value.trim();
        if (!url) return alert("Please enter a URL.");
        try {
          const data = await extractWebsiteData(url);
          console.log("Scraped Data:", data);
          updatePostcard(data);
        } catch (err) {
          console.error(err);
          alert("Scraping failed. Check console for details.");
        }
      });

      downloadBtn.addEventListener("click", () => {
        const target = document.getElementById("postcard").style.display !== "none" ?
                       document.getElementById("postcard") :
                       document.getElementById("fallback");
        html2canvas(target).then((canvas) => {
          const link = document.createElement("a");
          link.download = "postcard.png";
          link.href = canvas.toDataURL();
          link.click();
        });
      });
    });

    // Fetch scraped data from our Netlify function.
    async function extractWebsiteData(url) {
      const res = await fetch("/.netlify/functions/scrape", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url })
      });
      if (!res.ok) {
        const errText = await res.text();
        throw new Error(`Scrape failed: ${res.status} ${res.statusText} - ${errText}`);
      }
      return await res.json();
    }

    // Update the postcard UI using the scraped data.
    function updatePostcard(data) {
      // Apply the scraped primary font to the postcard.
      document.documentElement.style.setProperty("--primary-font", data.primaryFont || "Merriweather");
      document.body.style.fontFamily = `var(--primary-font)`;

      // Set background color on left panel.
      const leftPanel = document.getElementById("postcard-left");
      leftPanel.style.backgroundColor = data.brandColor || "#1F2937";
      // Determine appropriate text color based on background.
      leftPanel.style.color = getContrastColor(data.brandColor || "#1F2937");

      // If a brand logo is available, show it; otherwise, hide the logo wrapper.
      const logoWrapper = document.getElementById("logoWrapper");
      const logoImg = document.getElementById("logo");
      if (data.logoUrl) {
        logoWrapper.style.display = "block";
        logoImg.src = data.logoUrl;
      } else {
        logoWrapper.style.display = "none";
      }

      // Set product name and price.
      document.getElementById("productName").textContent = data.productName || "";
      document.getElementById("productPrice").textContent = data.productPrice || "";

      // Set product image.
      const productImage = document.getElementById("productImage");
      if (data.productImageUrl) {
        productImage.src = data.productImageUrl;
        productImage.style.display = "block";
      } else {
        productImage.style.display = "none";
      }

      // If product name and image are missing, show fallback.
      if (!data.productName && !data.productImageUrl) {
        document.getElementById("postcard").style.display = "none";
        const fallback = document.getElementById("fallback");
        fallback.style.display = "flex";
        document.getElementById("fallbackText").textContent = `${data.brandName}\n${data.brandDomain}`;
      } else {
        document.getElementById("postcard").style.display = "flex";
        document.getElementById("fallback").style.display = "none";
      }
    }

    // Utility: Contrast function â€“ returns white or black.
    function getContrastColor(hex) {
      hex = hex.replace("#", "");
      const r = parseInt(hex.substr(0,2),16);
      const g = parseInt(hex.substr(2,2),16);
      const b = parseInt(hex.substr(4,2),16);
      const yiq = ((r*299)+(g*587)+(b*114))/1000;
      return yiq >= 128 ? "#000" : "#fff";
    }
  </script>
</body>
</html>
